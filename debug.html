<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netlify 部署调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .error { background: #ffebee; border-color: #f44336; }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1976d2; }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .test-result.success { background: #e8f5e8; border-color: #4caf50; }
        .test-result.error { background: #ffebee; border-color: #f44336; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Netlify 部署调试页面</h1>
        
        <div class="info-box success">
            <h3>✅ 如果你能看到这个页面，说明基本部署是成功的！</h3>
            <p>这个页面将帮助你诊断 404 问题的具体原因。</p>
        </div>

        <div class="info-box">
            <h3>📊 基本信息</h3>
            <p><strong>当前URL:</strong> <span id="current-url"></span></p>
            <p><strong>域名:</strong> <span id="hostname"></span></p>
            <p><strong>是否为Netlify环境:</strong> <span id="is-netlify"></span></p>
            <p><strong>用户代理:</strong> <span id="user-agent"></span></p>
        </div>

        <h3>🧪 文件测试</h3>
        <button onclick="testFile('/')">测试首页 (/)</button>
        <button onclick="testFile('/index.html')">测试 index.html</button>
        <button onclick="testFile('/news/news.html')">测试新闻页面</button>
        <button onclick="testFile('/news/news.json')">测试 news.json</button>
        <button onclick="testFile('/api/news')">测试 API 端点</button>
        <button onclick="testAllFiles()">🔍 测试所有关键文件</button>

        <div id="test-results"></div>

        <div class="info-box warning">
            <h3>💡 常见 404 原因</h3>
            <ul>
                <li><strong>重定向规则冲突:</strong> _redirects 和 netlify.toml 中的规则可能冲突</li>
                <li><strong>文件路径错误:</strong> 检查文件是否在正确位置</li>
                <li><strong>构建配置问题:</strong> publish 目录设置不正确</li>
                <li><strong>缓存问题:</strong> Netlify CDN 缓存了旧的配置</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>📋 解决步骤</h3>
            <ol>
                <li>运行上面的文件测试，查看哪些文件无法访问</li>
                <li>检查 Netlify 控制台的部署日志</li>
                <li>在 Netlify 中清除缓存并重新部署</li>
                <li>验证 _redirects 文件配置</li>
            </ol>
        </div>
    </div>

    <script>
        // 页面加载时显示基本信息
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('user-agent').textContent = navigator.userAgent;
            
            // 检测是否为 Netlify 环境
            const hostname = window.location.hostname;
            const isNetlify = hostname.includes('netlify.app') || 
                             hostname.includes('netlify.com') ||
                             hostname.includes('craft.luminolsuki.moe');
            document.getElementById('is-netlify').textContent = isNetlify ? '是 ✅' : '否 ❌';
            
            console.log('🔧 调试页面加载完成');
            console.log('📍 当前环境:', {
                url: window.location.href,
                hostname: hostname,
                isNetlify: isNetlify,
                pathname: window.location.pathname
            });
        });

        async function testFile(path) {
            const resultsDiv = document.getElementById('test-results');
            const testResult = document.createElement('div');
            testResult.className = 'test-result';
            
            try {
                console.log(`🧪 测试文件: ${path}`);
                const startTime = Date.now();
                const response = await fetch(path, { 
                    cache: 'no-cache',
                    method: 'HEAD' // 使用 HEAD 请求节省带宽
                });
                const endTime = Date.now();
                
                const result = {
                    path: path,
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    url: response.url,
                    redirected: response.redirected,
                    responseTime: endTime - startTime,
                    contentType: response.headers.get('content-type')
                };
                
                console.log('📊 测试结果:', result);
                
                if (response.ok) {
                    testResult.className += ' success';
                    testResult.innerHTML = `
                        <h4>✅ ${path} - 成功</h4>
                        <p><strong>状态:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>实际URL:</strong> ${response.url}</p>
                        <p><strong>响应时间:</strong> ${endTime - startTime}ms</p>
                        <p><strong>内容类型:</strong> ${response.headers.get('content-type') || '未知'}</p>
                        ${response.redirected ? '<p><strong>⚠️ 发生了重定向</strong></p>' : ''}
                    `;
                } else {
                    testResult.className += ' error';
                    testResult.innerHTML = `
                        <h4>❌ ${path} - 失败</h4>
                        <p><strong>状态:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>实际URL:</strong> ${response.url}</p>
                        <p><strong>可能原因:</strong> 文件不存在或重定向配置错误</p>
                    `;
                }
            } catch (error) {
                console.error(`❌ 测试 ${path} 失败:`, error);
                testResult.className += ' error';
                testResult.innerHTML = `
                    <h4>❌ ${path} - 网络错误</h4>
                    <p><strong>错误:</strong> ${error.message}</p>
                    <p><strong>可能原因:</strong> 网络问题或CORS限制</p>
                `;
            }
            
            resultsDiv.appendChild(testResult);
        }

        async function testAllFiles() {
            const files = ['/', '/index.html', '/news/news.html', '/news/news.json', '/api/news'];
            document.getElementById('test-results').innerHTML = '<h3>🔍 正在测试所有关键文件...</h3>';
            
            for (const file of files) {
                await testFile(file);
                // 添加小延迟避免过快请求
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            console.log('✅ 所有文件测试完成');
        }
    </script>
</body>
</html>
